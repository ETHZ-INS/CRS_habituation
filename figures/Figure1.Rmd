---
title: "Timeline of Acute Restraint Stress (ARS)"
author: "Pierre-Luc Germain"
date: "2023-05-23"
output: html_document
---

```{r setup}
knitr::opts_chunk$set(dev="CairoPNG")
suppressPackageStartupMessages({
  library(sechm)
  library(edgeR)
  library(stageR)
  library(ggplot2)
  library(cowplot)
  library(patchwork)
  library(clusterProfiler)
})
source("../functions/functions.R")
source("../functions/clusterProfiling.R")
th.lfc <- log2(1.3)
```


```{r}
se <- readRDS("../rnaDEAs/ARS.SE.rds")
ann <- HeatmapAnnotation(df=as.data.frame(colData(se)[,c("TimePoint","Sex")]),
                         col=metadata(se)$anno_colors, show_legend=c(FALSE,TRUE), show_annotation_name=FALSE)
adegs <- getDEGs(getDEA(se)[c("45min","1h30","3h")], lfc.th = th.lfc)
h0 <- sechm(se, adegs, assayName="scaledLFC", top_annotation = ann, gaps_at="TimePoint", row_title="ARS DEGs",
            column_title_rot=90, column_title_gp=gpar(fontsize=11), row_title_gp=gpar(fontsize=12), annocol_title_side=NA, use_raster=TRUE)
```


```{r, fig.width=11, fig.height=3.5}
adegs <- getDEGs(getDEA(se)[c("45min","1h30","3h")], lfc.th = th.lfc)
mdsp <- mdsTimePlot(se, adegs) + mytheme()

uns <- readRDS("../rnaDEAs/all.unspliced.SE.rds")
uns <- uns[,!grepl("CRS",uns$Experiment)]
uns.degs <- getDEGs(getDEA(uns)[1:5], lfc.th = th.lfc)
mdsp2 <- mdsTimePlot(uns, uns.degs) + mytheme()

mds <- (mdsp + ggtitle("Full transcriptome")) + 
  (mdsp2 + ggtitle("Active transcription")) + 
  plot_layout(guides="collect") & 
  theme(title=element_text(size=10), legend.position = "bottom", legend.title.position = "top") & 
  guides(
  color = guide_legend(nrow = 1),
  shape = guide_legend(nrow = 1)
)


plot_grid(grid.grabExpr(draw(h0, merge=TRUE)), mds, nrow=1, rel_widths=c(1,2))
```

```{r, fig.width=11, fig.height=2}
d <- dplyr::bind_rows(lapply(getDEA(se)[1:5], FUN=function(x){
  x <- x[!is.na(x$PValue),]
  cbind(gene=row.names(x), x[,-4])
}), .id="TimePoint")
d$TimePoint <- factor(d$TimePoint, levels(se$TimePoint)[-1])
d$sig <- factor(ifelse(d$FDR<0.05 & abs(d$logFC)>th.lfc, "DEG", "n.s."), c("DEG","n.s."))
vol <- ggplot(d, aes(logFC, -log10(FDR))) + ggrastr::geom_point_rast(size=0.5, colour="darkgrey") + 
  geom_point(data=d[d$FDR<0.05,], size=0.5, aes(colour=sig)) + 
  scale_color_manual(values=c("n.s."="darkgrey", "DEG"="darkblue"), guide=guide_legend(override.aes = list(size=3.5))) +
  mytheme() + facet_wrap(~TimePoint, nrow=1, scales="free") +
  scale_x_continuous(breaks=c(-2,0,2), limits=c(-2,2.5)) + 
  scale_y_sqrt(breaks=c(2,15,40), limits=c(0,40)) + labs(color="Significant")
vol
```


```{r}
se <- readRDS("../rnaDEAs/all.full.SE.rds")
se <- updateSEforPlots(se)
levels(se$Treatment) <- gsub(" +","\n +", levels(se$Treatment), fixed=TRUE)
names(metadata(se)$anno_colors$Treatment) <- gsub(" +","\n +", names(metadata(se)$anno_colors$Treatment), fixed=TRUE)
se <- se[,order(se$TimePoint, se$Treatment, grepl("CRS", se$Experiment), se$Sex)]
degs <- getDEGs(getDEA(se)[1:5], lfc.th = th.lfc)
ann <- HeatmapAnnotation(df=as.data.frame(colData(se)[,c("TimePoint","Treatment","Sex")]),
                         col=metadata(se)$anno_colors, show_legend=c(FALSE,TRUE,TRUE), show_annotation_name=FALSE)
h1 <- sechm(se, degs, gaps_at="TimePoint", top_annotation=ann, assayName = "scaledLFC", row_title="All stress-responsive genes",
            column_title_rot=90, row_title_gp=gpar(fontsize=12), column_title_gp=gpar(fontsize=12), use_raster=TRUE)
```

```{r}
names(tp) <- tp <- c("45min","1h30","3h")
d <- dplyr::bind_rows(lapply(tp, FUN=function(p){
  x <- getDEA(se, paste0("inter.Treatment10days.CRS.TimePoint",p))[degs,c("logFC","FDR")]
  y <- getDEA(se, paste0("inter.Treatment20days.CRS.TimePoint",p))[degs,c("logFC","FDR")]
  colnames(x) <- paste0(colnames(x),".10days")
  colnames(y) <- paste0(colnames(y),".20days")
  cbind(gene=degs,x,y)
}), .id="TimePoint")
d <- d[which((d$FDR.10days<0.05 & abs(d$logFC.10days)>log2(1.15)) | 
               (d$FDR.20days<0.05 & abs(d$logFC.20days)>log2(1.15))),]
d$TimePoint <- factor(d$TimePoint,unique(d$TimePoint))
d$minFDR <- pmin(d$FDR.10days,d$FDR.20days)
fdrbr <- c(0.01,0.0001,0.000001,10^-10)
sp1 <- ggplot(d, aes(logFC.10days, logFC.20days)) + geom_vline(xintercept=0) + geom_hline(yintercept=0) +
  geom_abline(slope=1,intercept=0,linetype="dashed") + geom_smooth(method=MASS::rlm) +
  geom_point(aes(alpha=-log10(minFDR))) + facet_wrap(~TimePoint, scales="free") + theme_bw() +
  labs(x="CRS:ARS Interaction logFC (10days)", y="CRS:ARS Interaction\nlogFC (20days)", alpha="FDR") +
  scale_alpha_continuous(breaks=-log10(fdrbr), labels=format(fdrbr,scipen=0))
cc <- cor.test(d$logFC.10days,d$logFC.20days)
cortext <- paste0("cor=",round(cc$estimate,2), "\np=", format(cc$p.value, digit=1))
p3 <- ggplot(d, aes(logFC.10days, logFC.20days)) + 
  geom_vline(xintercept=0, color="darkgrey") + geom_hline(yintercept=0, color="darkgrey") +
  geom_abline(slope=1,intercept=0,linetype="dashed") + geom_smooth(method=MASS::rlm) +
  geom_point(aes(alpha=-log10(minFDR))) + mytheme() +
  labs(x="CRS:ARS Interaction logFC (10days)", y="CRS:ARS Interaction\nlogFC (20days)", alpha="FDR") +
  scale_alpha_continuous(breaks=-log10(fdrbr), labels=format(fdrbr,scipen=0)) +
  annotate("text",label=cortext,y=-1,x=3,hjust=1)
# pdf("crs_10_vs_20days_with_pval.pdf", width=4.5, height=3)
# p3
# dev.off()
```

```{r, fig.width=4, fig.height=3}
#g <- c("Fos", "Fosb", "Npas4", "Fkbp5")
g <- c("Fos","Fosb","Npas4","Egr1", "Apold1","Fkbp5")
d <- meltSE(se, g)
d$feature <- factor(d$feature, unique(d$feature))

dag <- agg4Ribb(d, "log2FC", by=c("Treatment","feature","TimePoint"), sem=TRUE)
dag <- dag[which(!(dag$TimePoint %in% c("24h"))),]
dag$Time <- c(0,45,90,180,240,5.5*60,24*60)[as.integer(dag$TimePoint)]
levels(dag$Treatment) <- gsub(" +", "\n +", levels(dag$Treatment), fixed=TRUE)

crscols <- metadata(se)$anno_colors$Treatment
crscols[1] <- "grey"
names(crscols) <- levels(dag$Treatment)

pg <- ggplot(dag, aes(Time, log2FC, fill=Treatment)) +
    geom_hline(yintercept=0, linetype="dashed", colour="grey") +
    geom_line(aes(colour=Treatment), linewidth=1.1) + 
    geom_point(aes(colour=Treatment), size=2.5) +
    geom_ribbon(aes(ymin=lower, ymax=upper), alpha=0.4) +
    facet_wrap(~feature, scales="free", nrow=2) +
    labs(x="Time (min)", y="log2(fold-change)") + mytheme(xax = TRUE) +
    scale_y_continuous(breaks=scales::pretty_breaks(n=2)) +
  scale_x_continuous(breaks=c(0,90,180,270)) + 
    scale_fill_manual(values=crscols, guide="none") +
    scale_color_manual(values=crscols) +
    theme(legend.position = "bottom", legend.title.position = "top",
          axis.text.x=element_text(angle=90, hjust=1, vjust=0.5))
pg
```


```{r, fig.width=11, fig.height=3}
bl <- readRDS("../rnaDEAs/baselineDEAs.rds")
d <- dplyr::bind_rows(lapply(bl[-3], FUN=function(x){
  x <- x[!is.na(x$PValue),]
  cbind(gene=row.names(x), x[,-3])
}), .id="CRS")
d$CRS <- factor(d$CRS, c("CRS10d","CRS20d","both"), c("10 days", "20 days", "CRS (10+20 days)"))
d$sig <- d$FDR<0.05 & abs(d$logFC)>th.lfc
vol2 <- ggplot(d, aes(logFC, -log10(FDR))) + ggrastr::geom_point_rast(size=0.5, colour="darkgrey") + 
  geom_point(data=d[d$FDR<0.05,], size=0.5, aes(colour=sig)) + 
  scale_color_manual(values=c("FALSE"="darkgrey", "TRUE"="darkblue")) +
  mytheme() + theme(legend.position = "none") + facet_wrap(~CRS, nrow=1) +
  geom_hline(yintercept = -log10(0.05), linetype="dashed") + 
  scale_x_continuous(breaks=c(-2,0,2), limit=c(-2,2.5)) + 
  ylim(c(0,1.5))

pg + vol2
```


```{r, fig.width=10, fig.height=13}
pdf("Figure1.pdf", width=10, height=13)
plot_grid(
  plot_grid(NULL, labels="A"),
  plot_grid(grid.grabExpr(draw(h0, merge=TRUE)), mds, nrow=1, rel_widths=c(1,2), labels=c("B","C"), scale=0.95),
  plot_grid(vol, scale=0.95, labels="D"), 
  plot_grid(
    plot_grid(grid.grabExpr(draw(h1, merge=TRUE)), vol2, nrow=2, scale=0.95, rel_heights = c(3,1), labels=c("E","H")),
    plot_grid(p3, pg + theme(legend.position = "bottom"), nrow=2, scale=0.95, rel_heights = c(2,3), labels=c("F","G")), nrow=1, rel_widths = c(5,4)
  ),
  nrow=4, rel_heights = c(1.7,3,1.3,6)
)
dev.off()
```

