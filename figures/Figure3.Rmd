---
title: "Figure 3 - damping patterns"
author: "Pierre-Luc Germain"
output: html_document
---

```{r setup}
knitr::opts_chunk$set(dev="CairoPNG")
suppressPackageStartupMessages({
  library(sechm)
  library(edgeR)
  library(stageR)
  library(ggplot2)
  library(cowplot)
  library(patchwork)
  library(clusterProfiler)
})
source("../functions/functions.R")
source("../functions/clusterProfiling.R")
th.lfc <- log2(1.15)
```


```{r}
se <- readRDS("../rnaDEAs/Cort.SE.rds")
d <- getDEA(se)[[1]]
d$sig <- factor(ifelse(d$FDR<0.05 & abs(d$logFC)>th.lfc, "DEG", "n.s."), c("DEG","n.s."))
vol <- ggplot(d, aes(logFC, -log10(FDR))) + ggrastr::geom_point_rast(size=0.5, colour="darkgrey") + 
  geom_point(data=d[d$FDR<0.05,], size=0.5, aes(colour=sig)) + 
  scale_color_manual(values=c("n.s."="darkgrey", "DEG"="darkblue"), guide=guide_legend(override.aes = list(size=3.5))) +
  mytheme() + 
  scale_x_continuous(breaks=c(-2,0,2), limits=c(-2,2.5)) + 
  scale_y_sqrt(breaks=c(2,15,40), limits=c(0,40)) + labs(color="Significant")
vol
```


```{r}
crs <- readRDS("../rnaDEAs/all.full.SE.rds")
assays(crs)$logcpm <- log1p(cpm(DGEList(assay(crs))))
crs <- crs[,crs$TimePoint %in% c("0min","3h")]

se$TimePoint <- "3h"
se$Treatment <- gsub("Restraint", "10days CRS", se$Treatment)
levels(crs$Sex) <- c("F","M")

mse <- SEtools::mergeSEs(list("original\nexperiment"=crs, "replication\nexperiment"=se), use.assays = c("logcpm"), do.scale = FALSE)
mse$Batch <- gsub("[0-9]","", mse$Batch)
tmp <- paste0(mse$TimePoint, ifelse(is.na(mse$Solution), "Vehicle", as.character(mse$Solution)))
tmp[which(mse$TimePoint=="0min" | mse$Solution=="Vehicle")] <- "control"
tmp <- relevel(factor(tmp), "0min")
mm <- model.matrix(~mse$Sex+tmp+mse$Treatment:tmp)
assays(mse)$corrected <- sva::ComBat(assay(mse, "logcpm"), batch=mse$Batch, mm[,colSums(mm)>0])
mse <- mse[,order(mse$Dataset, mse$TimePoint, mse$Treatment, mse$Sex)]
mse <- log2FC(mse, "corrected", mse$TimePoint=="0min", isLog = TRUE)
```

```{r, fig.width=4, fig.height=2.6}
dea1 <- getDEA(crs, "3h")

mse <- updateSEforPlots(mse, dark=FALSE)

hmcort <- sechm(mse[,!grepl("CRS4",colnames(mse))], getDEGs(crs, "3h", lfc.th = 0.15, fdr.th = 0.01), top_annotation = c("TimePoint","Treatment"), breaks=0.99, assayName="scaledLFC", use_raster=TRUE)
hmcort <- grid.grabExpr(draw(hmcort, merge=TRUE), wrap.grobs=TRUE)

e <- assay(mse, "corrected")[intersect(getDEGs(crs, "3h", lfc.th = 0.15), row.names(mse)),]
e <- e-rowMeans(e[,mse$TimePoint=="0min"])
x <- rowMeans(e[,grepl("Handling",mse$Treatment) & mse$TimePoint=="3h"])
mse$coef2 <- apply(e,2,\(y){
  coef(summary(MASS::rlm(y~0+x)))[1,1]
})

d <- as.data.frame(colData(mse))
d$group <- factor(ifelse(d$TimePoint=="3h", paste0("3h ARS", ifelse(grepl("original",d$Dataset), "\noriginal", "\nreplication")), "Baseline"),
                  c("Baseline","3h ARS\noriginal", "3h ARS\nreplication"))

p <- ggplot(d, aes(group, coef2)) + 
  geom_boxplot(aes(fill=Treatment, color=Treatment), outlier.colour = NA) + theme_bw() + mytheme() +
    #geom_point(position=position_jitterdodge(), size=1.5, mapping=aes(shape=Sex, group=Treatment)) +
    ylab("3h stress\nresponse coefficient")

mod <- lm(coef2~group*Treatment, data=d)
summary(mod)
p <- boxplotColors(p, updateSEforPlots(crs)) + 
  ggsignif::geom_signif(y_position = max(d$coef2)*c(1.08,1.2,1.08),
                          xmin=c(1.75,1.75,2.8),
                          xmax=c(2,2.25,3.2),
                          vjust=0.5,
                          annotations=c("***","***","**"), 
                          tip_length = 0, textsize=5) +
  xlab(NULL) + mytheme()# + scale_fill_manual(values=metadata(mse)$anno_colors$Treatment)


# pdf("Cort.pdf", width=4.5, height=3)
# p
# dev.off()
```

For stats reporting:

```{r}
ds <- as.data.frame(coef(summary(mod))[c(4:8),])
row.names(ds) <- gsub("days CRS","dCRS",gsub("Treatment|group3h | +ARS", "", row.names(ds)))
paste(paste0(row.names(ds), " b=", round(ds$Estimate,2),"+/-",round(ds$`Std. Error`,2), " t=",round(ds$`t value`,1), " p=", format(ds$`Pr(>|t|)`, digits=2)), collapse="; ")
```


```{r, fig.width=12, fig.height=4}
pdf("Figure3.pdf", width=12, height=4)
plot_grid(hmcort, NULL, p + theme(legend.position = "top", legend.title=element_blank()), nrow=1,labels=c("K","L","M"), scale=0.95, rel_widths=c(9,5,10))
dev.off()
```





```{r, fig.width=11, fig.height=7}
d2 <- d[!is.na(d$CORT_90min),]
fkbp5 <- setNames(assay(se,"logcpm")["Fkbp5",], paste0("Cort.",colnames(se)))
d2$Fkbp5 <- fkbp5[row.names(d2)]

d3 <- reshape2:::melt.data.frame(d2, id.vars=c("Treatment", "TimePoint", "Sex", "coef2", "Fkbp5"), measure.vars = grep("^CORT_", colnames(d), value=TRUE))
d3$variable <- factor(gsub("CORT_","",d3$variable), c("0min","15min","45min","90min","180min"))
d3$Sex <- factor(d3$Sex)
levels(d3$Sex) <- c("Female","Male")
cp1 <- ggplot(d3, aes(coef2, value, color=Treatment)) + geom_point() + facet_wrap(Sex~variable, scales="free", nrow=2) + scale_x_continuous(breaks=scales::pretty_breaks(3)) + scale_y_continuous(breaks=scales::pretty_breaks(3)) + mytheme()

d4 <- dplyr::bind_rows(lapply(split(d3, paste(d3$TimePoint, d3$Sex, d3$variable)), \(x){
  o <- x[1,c("TimePoint","Sex","variable"),drop=FALSE]
  ct <- cor.test(x$coef2, x$value)
  o$label <- paste0("cor=",round(ct$estimate,2),"; p=", format(ct$p.value, digit=2))
  o$coef2 <- max(x$coef2)
  rv <- range(x$value)
  o$value <- rv[2]+diff(rv)/10
  o
}))

cp1 <- cp1 + geom_text(data=d4, color="black", aes(label=label), size=3, hjust=1) +
  labs(x="3h transcriptional response coefficient", y="Cort level") +
  scale_color_manual(values=c(`Handling +ARS` = "grey", `10days CRS +ARS` = "slateblue"))

# plots <- lapply(grep("^CORT_", colnames(d), value=TRUE), \(x){
#   
#   ggplot(d2, aes(coef2, .data[[x]], colour=Treatment, shape=Sex)) + geom_point(size=3) + 
#     mytheme() + xlab("Response coefficient") + labs(subtitle=ct) +
#     ylab(gsub("CORT_","CORT at ",x))
# })
# Reduce("+", plots) + plot_layout(guides="collect")
```

```{r, fig.width=11, fig.height=10}
cp3 <- ggplot(d3, aes(Fkbp5, value, color=Treatment)) + geom_point() + facet_wrap(Sex~variable, scales="free", nrow=2) + scale_x_continuous(breaks=scales::pretty_breaks(3)) + scale_y_continuous(breaks=scales::pretty_breaks(3)) + mytheme()

d4 <- dplyr::bind_rows(lapply(split(d3, paste(d3$TimePoint, d3$Sex, d3$variable)), \(x){
  o <- x[1,c("TimePoint","Sex","variable"),drop=FALSE]
  ct <- cor.test(x$Fkbp5, x$value)
  o$label <- paste0("cor=",round(ct$estimate,2),"; p=", format(ct$p.value, digit=2))
  # o$Fkbp5 <- max(d3$Fkbp5[which(d3$variable==o$variable)])
  # rv <- range(d3$value[which(d3$Sex==o$Sex)])
  o$Fkbp5 <- max(x$Fkbp5)
  rv <- range(x$value)
  o$value <- rv[2]+diff(rv)/10
  o
}))

cp3 <- cp3 + geom_text(data=d4, color="black", aes(label=label), size=3, hjust=1) +
  labs(x="Fkbp5 expression (logCPM) at 3h", y="Cort level") +
  scale_color_manual(values=c(`Handling +ARS` = "grey", `10days CRS +ARS` = "slateblue"))

pdf("Supp_cort_correlations.pdf", width=11, height=11)
cp1 / cp3 + plot_layout(guides="collect") & theme(legend.position = "bottom")
dev.off()
```
